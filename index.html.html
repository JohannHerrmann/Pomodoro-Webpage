<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pomodoro Naturklang Timer ‚Äì Pro</title>
  <style>
    :root{
      --bg:#0b1220;--panel:#121926;--panel2:#0e1624;--muted:#94a2be;--text:#eef2ff;--accent:#6aa6ff;--accent2:#8ef0c9;--ring1:#ffb347;--ring2:#ff6a6a;--ok:#37c172;--warn:#ff6a8e;
      --shadow:0 10px 30px rgba(0,0,0,.35), 0 2px 8px rgba(0,0,0,.25);
    }
    body.light{
      --bg:#f6f8fb;--panel:#ffffff;--panel2:#e9f0ff;--muted:#5b6b82;--text:#0e1b2b;--accent:#3b82f6;--accent2:#22c55e;--ring1:#fb923c;--ring2:#ef4444;--ok:#16a34a;--warn:#ef476f;
      --shadow:0 8px 30px rgba(7,17,45,.12), 0 1px 6px rgba(7,17,45,.08);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:radial-gradient(1000px 600px at 10% -30%, var(--panel2) 0%, var(--bg) 60%) no-repeat, var(--bg);color:var(--text);}
    .wrap{max-width:1100px;margin:24px auto;padding:8px 20px}
    header{margin-bottom:12px;display:flex;align-items:center;justify-content:space-between}
    h1{font-size:22px;margin:0 0 8px 6px;color:var(--text);}

    .app{display:grid;grid-template-columns:1.2fr .8fr;gap:18px}
    @media (max-width:900px){.app{grid-template-columns:1fr}}

    .card{background:linear-gradient(180deg,rgba(255,255,255,.05),rgba(255,255,255,.03));border:1px solid rgba(255,255,255,.08);border-radius:22px;box-shadow:var(--shadow)}
    body.light .card{background:linear-gradient(180deg,rgba(255,255,255,.9),rgba(255,255,255,.85));border:1px solid rgba(7,17,45,.08)}

    /* LEFT: TIMER */
    .timer{display:grid;grid-template-rows:auto 1fr auto;gap:14px;padding:22px}
    .phaseTitle{font-weight:700;text-align:center;color:#ffde9c;text-shadow:0 2px 10px rgba(255,210,120,.35)}
    body.light .phaseTitle{color:#8a5a00;text-shadow:none}
    .ringBox{display:grid;place-items:center;}
    .ring{width:min(72vw,420px);max-width:540px;aspect-ratio:1/1;display:grid;place-items:center;}
    .ring svg{width:100%;height:100%;display:block;}
    .inner{position:relative;display:grid;place-items:center}
    .time{font-size:clamp(36px,9vw,64px);font-weight:800;letter-spacing:.5px;}
    .centerCaption{margin-top:6px;font-weight:600;color:var(--muted)}
    .tomato{font-size:clamp(40px,8vw,64px);filter:drop-shadow(0 2px 6px rgba(0,0,0,.35));}
    .controls{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin-top:6px}
    .btn{cursor:pointer;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.06);color:var(--text);padding:12px 16px;border-radius:999px}
    .btn.primary{background:linear-gradient(180deg,rgba(55,193,114,.22),rgba(55,193,114,.1));border-color:rgba(55,193,114,.5)}
    .btn.warn{background:linear-gradient(180deg,rgba(255,106,142,.22),rgba(255,106,142,.1));border-color:rgba(255,106,142,.5)}
    .btn:disabled{opacity:.55;cursor:not-allowed}
    body.light .btn{background:#f4f7ff;border-color:rgba(7,17,45,.12)}

    /* RIGHT: SETTINGS */
    .panel{padding:20px;display:grid;gap:14px}
    .row{display:grid;grid-template-columns:1fr auto;gap:10px;align-items:center}
    .label{font-size:13px;color:var(--muted)}
    .ctl{background:#0d1628;border:1px solid rgba(255,255,255,.08);color:var(--text);border-radius:14px;padding:10px 12px}
    body.light .ctl{background:#f6f8ff;border:1px solid rgba(7,17,45,.08);color:#0e1b2b}
    .slider{appearance:none;width:100%}
    .slider::-webkit-slider-thumb{appearance:none;width:18px;height:18px;border-radius:50%;background:#fff;box-shadow:0 0 0 3px #2b4570}
    .slider::-webkit-slider-runnable-track{height:6px;border-radius:999px;background:linear-gradient(90deg,#243352,#1a2a49)}
    body.light .slider::-webkit-slider-runnable-track{background:linear-gradient(90deg,#bcd3ff,#9ab7ff)}
    .switch{appearance:none;width:44px;height:26px;border-radius:999px;background:#2a3654;position:relative;border:1px solid rgba(255,255,255,.12);cursor:pointer}
    .switch::after{content:"";position:absolute;inset:3px 24px 3px 3px;border-radius:999px;background:white;transition:all .18s}
    .switch:checked{background:#37c172}
    .switch:checked::after{inset:3px 3px 3px 24px}

    .footer{margin-top:12px;color:var(--muted);font-size:12.5px;text-align:center}
    .small{font-size:12px;color:var(--muted)}

    details.dev{margin-top:4px}
    details.dev summary{cursor:pointer;color:#bcd3ff}
    body.light details.dev summary{color:#345}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1 id="title">Pomodoro Fokus Timer</h1>
      <div style="display:flex;gap:10px;align-items:center">
        <div class="label" id="labelLanguage">Sprache</div>
        <select id="lang" class="ctl">
          <option value="de" selected>Deutsch</option>
          <option value="en">English</option>
        </select>
        <div class="label" id="labelTheme">Theme</div>
        <select id="theme" class="ctl">
          <option value="dark" selected>Dunkel</option>
          <option value="light">Hell</option>
        </select>
      </div>
    </header>

    <div class="app">
      <!-- LEFT: TIMER -->
      <section class="card timer">
        <div class="phaseTitle" id="phaseTitle">Konzentrationsphase</div>

        <div class="ringBox">
          <div class="ring">
            <svg viewBox="0 0 100 100" aria-hidden="true">
              <defs>
                <linearGradient id="ringGrad" x1="0" y1="0" x2="1" y2="1">
                  <stop offset="0%" stop-color="var(--ring1)"/>
                  <stop offset="100%" stop-color="var(--ring2)"/>
                </linearGradient>
              </defs>
              <circle cx="50" cy="50" r="45" stroke="rgba(255,255,255,.09)" stroke-width="8" fill="none" />
              <circle id="ringProgress" cx="50" cy="50" r="45" stroke="url(#ringGrad)" stroke-width="8" fill="none" stroke-linecap="round" transform="rotate(-90 50 50)" stroke-dasharray="282.6" stroke-dashoffset="282.6" />
            </svg>
            <div class="inner">
              <div class="tomato" aria-hidden>üçÖ</div>
              <div class="time" id="time">25:00</div>
              <div class="centerCaption" id="centerCaption">Fokus!</div>
              <div class="small" id="cycleInfo" style="margin-top:6px">Einzelzyklus</div>
            </div>
          </div>
        </div>

        <div class="controls">
          <button id="startBtn" class="btn primary">Zyklus starten</button>
          <button id="pauseBtn" class="btn" disabled>Pausieren</button>
          <button id="resetBtn" class="btn warn" disabled>Zur√ºcksetzen</button>
        </div>
      </section>

      <!-- RIGHT: SETTINGS -->
      <aside class="card panel">
        <div class="row">
          <div class="label" id="labelSpeak">Ansagen per Sprachausgabe</div>
          <input id="speakToggle" class="switch" type="checkbox" checked>
        </div>

        <div class="row">
          <div class="label" id="labelFocusMin">Dauer Konzentrationsphase (Min)</div>
          <input id="focusMinutes" class="ctl" type="number" min="1" max="180" value="25">
        </div>
        <input id="focusRange" class="slider" type="range" min="1" max="180" value="25">

        <div class="row">
          <div class="label" id="labelBreakMin">Dauer Pausenphase (Min)</div>
          <input id="breakMinutes" class="ctl" type="number" min="1" max="60" value="5">
        </div>
        <input id="breakRange" class="slider" type="range" min="1" max="60" value="5">

        <div class="row">
          <div class="label" id="labelLongBreak">Langer Break (Min, alle 4 Zyklen)</div>
          <input id="longBreakMinutes" class="ctl" type="number" min="1" max="60" value="15">
        </div>

        <div class="row">
          <div class="label" id="labelFocusSound">Naturklang ‚Äì Konzentrationsphase</div>
          <select id="focusSound" class="ctl">
            <option value="rain">Regen</option>
            <option value="ocean">Meeresrauschen</option>
            <option value="forest">Wald / Wind</option>
            <option value="stream">Bachlauf</option>
            <option value="fire">Kaminfeuer</option>
            <option value="crickets">Grillen</option>
            <option value="brown">Brown Noise</option>
            <option value="silence">Stille</option>
          </select>
        </div>

        <div class="row">
          <div class="label" id="labelBreakSound">Klang ‚Äì Pausenphase</div>
          <select id="breakSound" class="ctl">
            <option value="ambient">Ambient Pad</option>
            <option value="chimes">Leises Glockenspiel</option>
            <option value="softbells">Weiche Bells</option>
            <option value="ocean">Meeresrauschen</option>
            <option value="silence">Stille</option>
          </select>
        </div>

        <div class="row">
          <div class="label" id="labelEndSignal">Signal am Phasenende</div>
          <select id="endSignal" class="ctl">
            <option value="none" selected>Keins</option>
            <option value="gong">Gong</option>
            <option value="bowl">Klangschale</option>
          </select>
        </div>

        <div class="row">
          <div class="label" id="labelDucking">Sanftes Aus-/Einblenden</div>
          <select id="ducking" class="ctl">
            <option value="true">Aktiv</option>
            <option value="false">Deaktiviert</option>
          </select>
        </div>

        <div class="row">
          <div class="label" id="labelCycles">Anzahl Zyklen</div>
          <input id="cyclesCount" class="ctl" type="number" min="1" max="24" value="1">
        </div>

        <div class="row">
          <div class="label" id="labelVol">Lautst√§rke (gesamt)</div>
          <input id="masterVol" class="slider" type="range" min="0" max="1" step="0.01" value="0.6">
        </div>

        <details class="dev">
          <summary id="testsSummary">Tests (schnelle √úberpr√ºfung)</summary>
          <div class="small" style="margin:6px 0 8px" id="testsHint">Setzt kurze Zeiten & startet automatisch.</div>
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <button id="test1" class="btn">2√ó (0.1 / 0.05 min)</button>
            <button id="test2" class="btn">3√ó (0.2 / 0.1 min)</button>
            <button id="test3" class="btn">4√ó (0.05 / 0.03, Lang 0.08)</button>
          </div>
        </details>

      </aside>
    </div>

    <p class="footer" id="footerNote">Hinweis: Diese Seite nutzt die <em>Web Audio API</em> und die <em>Sprachausgabe</em> des Browsers. Auf Mobilger√§ten muss die Audiowiedergabe mit einem Button gestartet werden (erledigt durch ‚ÄûZyklus starten‚Äú).</p>
  </div>

  <!-- End Cycle Modal -->
  <dialog id="repeatDialog" class="card" style="padding:0;max-width:min(520px,94vw)">
    <div style="padding:18px">
      <h3 id="modalTitle" style="margin:0 0 8px 0">Der Zyklus ist beendet</h3>
      <p id="modalQuestion" style="margin:0 0 12px 0">M√∂chtest du einen weiteren starten?</p>
      <div style="display:flex;gap:10px">
        <button id="repeatYes" class="btn primary">Ja, weiter</button>
        <button id="repeatNo" class="btn">Nein, stoppen</button>
      </div>
    </div>
  </dialog>

  <script>
    // ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
    // Shortcuts
    // ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
    const $ = (s)=>document.querySelector(s);
    const timeEl=$('#time');
    const ringEl=$('#ringProgress');
    const phaseTitle=$('#phaseTitle');
    const caption=$('#centerCaption');
    const cycleInfoEl=$('#cycleInfo');

    const startBtn=$('#startBtn');
    const pauseBtn=$('#pauseBtn');
    const resetBtn=$('#resetBtn');

    // Controls
    const speakToggle=$('#speakToggle');
    const focusMinutesEl=$('#focusMinutes');
    const breakMinutesEl=$('#breakMinutes');
    const longBreakMinutesEl=$('#longBreakMinutes');
    const focusRange=$('#focusRange');
    const breakRange=$('#breakRange');
    const focusSoundEl=$('#focusSound');
    const breakSoundEl=$('#breakSound');
    const endSignalEl=$('#endSignal');
    const duckingEl=$('#ducking');
    const cyclesCountEl=$('#cyclesCount');
    const masterVolEl=$('#masterVol');
    const langSel=$('#lang');
    const themeSel=$('#theme');

    const repeatDialog=$('#repeatDialog');
    const repeatYes=$('#repeatYes');
    const repeatNo=$('#repeatNo');

    // i18n
    let LANG='de';
    const i18n={
      de:{title:'Pomodoro Fokus Timer', start:'Zyklus starten', pause:'Pausieren', resume:'Fortsetzen', reset:'Zur√ºcksetzen',
          speak:'Ansagen per Sprachausgabe', focusMin:'Dauer Konzentrationsphase (Min)', breakMin:'Dauer Pausenphase (Min)', longBreak:'Langer Break (Min, alle 4 Zyklen)',
          focusSound:'Naturklang ‚Äì Konzentrationsphase', breakSound:'Klang ‚Äì Pausenphase', endSignal:'Signal am Phasenende', ducking:'Sanftes Aus-/Einblenden', cycles:'Anzahl Zyklen', volume:'Lautst√§rke (gesamt)',
          testsSummary:'Tests (schnelle √úberpr√ºfung)', testsHint:'Setzt kurze Zeiten & startet automatisch.',
          footer:'Hinweis: Diese Seite nutzt die <em>Web Audio API</em> und die <em>Sprachausgabe</em> des Browsers. Auf Mobilger√§ten muss die Audiowiedergabe mit einem Button gestartet werden (erledigt durch ‚ÄûZyklus starten‚Äú).',
          ready:'Bereit', focus:'Konzentrationsphase', break:'Pausenphase', focusCap:'Fokus!', breakCap:'Pause',
          langLabel:'Sprache', themeLabel:'Theme', dark:'Dunkel', light:'Hell',
          modalTitle:'Der Zyklus ist beendet', modalQuestion:'M√∂chtest du einen weiteren starten?', yes:'Ja, weiter', no:'Nein, stoppen',
          speech:{start_break:'Nun beginnt deine Pause', long_break:'Nun beginnt deine lange Pause', next_focus:'Die n√§chste Konzentrationsphase beginnt!', cycle_end:'Der Zyklus ist beendet, m√∂chtest du einen weiteren starten?'}
      },
      en:{title:'Pomodoro Focus Timer', start:'Start cycle', pause:'Pause', resume:'Resume', reset:'Reset',
          speak:'Voice announcements', focusMin:'Focus duration (min)', breakMin:'Break duration (min)', longBreak:'Long break (min, every 4 cycles)',
          focusSound:'Nature sound ‚Äì Focus', breakSound:'Sound ‚Äì Break', endSignal:'End-of-phase signal', ducking:'Smooth fade in/out', cycles:'Number of cycles', volume:'Master volume',
          testsSummary:'Tests (quick)', testsHint:'Sets short times & auto-starts.',
          footer:'Note: This page uses the Web Audio API and the browser\'s speech synthesis. On mobile, audio must be started by a user gesture (the ‚ÄúStart cycle‚Äù button).',
          ready:'Ready', focus:'Focus session', break:'Break session', focusCap:'Focus!', breakCap:'Break',
          langLabel:'Language', themeLabel:'Theme', dark:'Dark', light:'Light',
          modalTitle:'Cycle finished', modalQuestion:'Do you want to start another one?', yes:'Yes', no:'No',
          speech:{start_break:'Your break starts now', long_break:'Your long break starts now', next_focus:'The next focus session is starting!', cycle_end:'The cycle has finished. Do you want to start another one?'}
      }
    };

    function applyLang(){
      const t=i18n[LANG];
      document.documentElement.lang=LANG==='de'?'de':'en';
      $('#title').textContent=t.title;
      $('#labelLanguage').textContent=t.langLabel;
      $('#labelTheme').textContent=t.themeLabel;
      $('#phaseTitle').textContent = currentPhase==='focus'?t.focus : currentPhase==='break'?t.break : t.ready;
      caption.textContent = currentPhase==='focus'?t.focusCap : currentPhase==='break'?t.breakCap : t.ready;
      startBtn.textContent=t.start; resetBtn.textContent=t.reset; pauseBtn.textContent=(ctx && ctx.state==='running')?t.pause:t.pause;
      $('#labelSpeak').textContent=t.speak;
      $('#labelFocusMin').textContent=t.focusMin;
      $('#labelBreakMin').textContent=t.breakMin;
      $('#labelLongBreak').textContent=t.longBreak;
      $('#labelFocusSound').textContent=t.focusSound;
      $('#labelBreakSound').textContent=t.breakSound;
      $('#labelEndSignal').textContent=t.endSignal;
      $('#labelDucking').textContent=t.ducking;
      $('#labelCycles').textContent=t.cycles;
      $('#labelVol').textContent=t.volume;
      $('#testsSummary').textContent=t.testsSummary;
      $('#testsHint').textContent=t.testsHint;
      $('#footerNote').innerHTML=t.footer;
      $('#modalTitle').textContent=t.modalTitle;
      $('#modalQuestion').textContent=t.modalQuestion;
      repeatYes.textContent=t.yes; repeatNo.textContent=t.no;
      setCycleInfo();
    }

    function setPauseButtonState(){ pauseBtn.textContent = (ctx && ctx.state==='running') ? i18n[LANG].pause : i18n[LANG].resume; }

    // Keep number inputs & ranges in sync
    function bindRange(num,range){
      num.addEventListener('input',()=>{ range.value=num.value; });
      range.addEventListener('input',()=>{ num.value=range.value; updateInitialTime(); });
    }
    bindRange(focusMinutesEl, focusRange);
    bindRange(breakMinutesEl, breakRange);

    function fmt(sec){ const m=Math.floor(sec/60).toString().padStart(2,'0'); const s=Math.floor(sec%60).toString().padStart(2,'0'); return `${m}:${s}`; }

    function speakMsg(key){ if(!speakToggle.checked) return; try{ const u=new SpeechSynthesisUtterance(i18n[LANG].speech[key]); u.lang = (LANG==='de'?'de-DE':'en-US'); speechSynthesis.cancel(); speechSynthesis.speak(u);}catch(e){} }

    function setCycleInfo(){
      const configured=Math.max(1,parseInt(cyclesCountEl.value||'1',10));
      const total=(currentPhase==='idle')?configured:totalCycles;
      if(total<=1) cycleInfoEl.textContent=(LANG==='de')?'Einzelzyklus':'Single cycle'; else cycleInfoEl.textContent=`${(LANG==='de')?'Zyklus':'Cycle'} ${currentCycle}/${total}`;
    }

    // ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
    // Audio Engine
    // ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
    let ctx, masterGain;
    function ensureAudio(){
      if(!ctx){
        ctx = new (window.AudioContext||window.webkitAudioContext)();
        masterGain=ctx.createGain();
        masterGain.gain.value=parseFloat(masterVolEl.value);
        masterGain.connect(ctx.destination);
      }
      if(ctx.state==='suspended') ctx.resume();
    }
    masterVolEl.addEventListener('input',()=>{ if(masterGain) masterGain.gain.value=parseFloat(masterVolEl.value); });

    function rampGain(g,value,time=0.7){ const now=ctx.currentTime; g.gain.cancelScheduledValues(now); g.gain.setValueAtTime(g.gain.value, now); g.gain.linearRampToValueAtTime(value, now+time); }
    function createNoiseBuffer(seconds=2){ const rate=ctx.sampleRate; const b=ctx.createBuffer(1,seconds*rate,rate); const d=b.getChannelData(0); for(let i=0;i<d.length;i++){ d[i]=Math.random()*2-1; } return b; }

    // Nature generators
    function makeRainNode(){ const src=ctx.createBufferSource(); src.buffer=createNoiseBuffer(2); src.loop=true; const bp=ctx.createBiquadFilter(); bp.type='bandpass'; bp.frequency.value=700; bp.Q.value=.6; const hp=ctx.createBiquadFilter(); hp.type='highpass'; hp.frequency.value=200; const delay=ctx.createDelay(1.0); delay.delayTime.value=.25; const feedback=ctx.createGain(); feedback.gain.value=.2; const wet=ctx.createGain(); wet.gain.value=.35; const out=ctx.createGain(); out.gain.value=.8; src.connect(bp); bp.connect(hp); hp.connect(out); hp.connect(delay); delay.connect(feedback); feedback.connect(delay); delay.connect(wet); wet.connect(out); return {start(){src.start();}, stop(){try{src.stop();}catch{}}, node:out}; }
    function makeOceanNode(){ const src=ctx.createBufferSource(); src.buffer=createNoiseBuffer(2); src.loop=true; const lp=ctx.createBiquadFilter(); lp.type='lowpass'; lp.frequency.value=800; const lfo=ctx.createOscillator(); lfo.type='sine'; lfo.frequency.value=.12; const lfoG=ctx.createGain(); lfoG.gain.value=350; const out=ctx.createGain(); out.gain.value=.8; lfo.connect(lfoG); lfoG.connect(lp.frequency); src.connect(lp); lp.connect(out); return {start(){src.start(); lfo.start();}, stop(){try{src.stop();}catch{} try{lfo.stop();}catch{}}, node:out}; }
    function makeForestNode(){ const src=ctx.createBufferSource(); src.buffer=createNoiseBuffer(2); src.loop=true; const hp=ctx.createBiquadFilter(); hp.type='highpass'; hp.frequency.value=120; const lp=ctx.createBiquadFilter(); lp.type='lowpass'; lp.frequency.value=1500; const lfo=ctx.createOscillator(); lfo.type='sine'; lfo.frequency.value=.07; const lfoG=ctx.createGain(); lfoG.gain.value=100; lfo.connect(lfoG); lfoG.connect(hp.frequency); const out=ctx.createGain(); out.gain.value=.75; src.connect(hp); hp.connect(lp); lp.connect(out); return {start(){src.start(); lfo.start();}, stop(){try{src.stop();}catch{} try{lfo.stop();}catch{}}, node:out}; }
    function makeStreamNode(){ const src=ctx.createBufferSource(); src.buffer=createNoiseBuffer(2); src.loop=true; const bp=ctx.createBiquadFilter(); bp.type='bandpass'; bp.frequency.value=450; bp.Q.value=0.7; const lfo=ctx.createOscillator(); lfo.type='sine'; lfo.frequency.value=0.2; const lfoG=ctx.createGain(); lfoG.gain.value=120; lfo.connect(lfoG); lfoG.connect(bp.frequency); const out=ctx.createGain(); out.gain.value=.8; src.connect(bp); bp.connect(out); return {start(){src.start(); lfo.start();}, stop(){try{src.stop();}catch{} try{lfo.stop();}catch{}}, node:out}; }
    function makeFireNode(){ const src=ctx.createBufferSource(); src.buffer=createNoiseBuffer(2); src.loop=true; const hp=ctx.createBiquadFilter(); hp.type='highpass'; hp.frequency.value=400; const lp=ctx.createBiquadFilter(); lp.type='lowpass'; lp.frequency.value=3000; const out=ctx.createGain(); out.gain.value=.7; src.connect(hp); hp.connect(lp); lp.connect(out); let id; function crackle(){ const o=ctx.createOscillator(); o.type='square'; o.frequency.value= Math.random()*2000+1200; const g=ctx.createGain(); g.gain.value=0.0001; o.connect(g).connect(out); const now=ctx.currentTime; g.gain.setValueAtTime(0.0001, now); g.gain.exponentialRampToValueAtTime(0.4, now+0.005); g.gain.exponentialRampToValueAtTime(0.0001, now+0.06); o.start(now); o.stop(now+0.08);} return {start(){ id=setInterval(()=>{ if(Math.random()<0.7) crackle(); }, 120); src.start(); }, stop(){ try{src.stop();}catch{} if(id) clearInterval(id); }, node:out}; }
    function makeCricketsNode(){ const out=ctx.createGain(); out.gain.value=.6; let id; function chirp(){ const o=ctx.createOscillator(); o.type='triangle'; o.frequency.value=4200+Math.random()*600; const g=ctx.createGain(); g.gain.value=0.0001; o.connect(g).connect(out); const now=ctx.currentTime; g.gain.setValueAtTime(0.0001, now); g.gain.exponentialRampToValueAtTime(0.3, now+0.02); g.gain.exponentialRampToValueAtTime(0.0001, now+0.2); o.start(now); o.stop(now+0.22);} return {start(){ id=setInterval(()=>{ chirp(); if(Math.random()<0.5) setTimeout(chirp, 80); }, 900); }, stop(){ if(id) clearInterval(id); }, node:out}; }
    function makeBrownNoiseNode(){ const src=ctx.createBufferSource(); src.buffer=createNoiseBuffer(2); src.loop=true; const lp=ctx.createBiquadFilter(); lp.type='lowpass'; lp.frequency.value=600; const out=ctx.createGain(); out.gain.value=.7; src.connect(lp); lp.connect(out); return {start(){src.start();}, stop(){try{src.stop();}catch{}}, node:out}; }

    function startNature(kind){ ensureAudio(); const maker={rain:makeRainNode,ocean:makeOceanNode,forest:makeForestNode,stream:makeStreamNode,fire:makeFireNode,crickets:makeCricketsNode,brown:makeBrownNoiseNode,silence:()=>({start(){},stop(){},node:ctx.createGain()})}[kind]||makeRainNode; const unit=maker(); const g=ctx.createGain(); g.gain.value=0.0; unit.node.connect(g).connect(masterGain); unit.start(); if(duckingEl.value==='true') rampGain(g,1.0,1.0); else g.gain.value=1.0; return ()=>{ if(duckingEl.value==='true'){ rampGain(g,0.0,0.8); setTimeout(()=>{unit.stop(); g.disconnect();},850);} else { try{unit.stop();}catch{} g.disconnect(); } }; }

    // Break sounds
    function makeAmbientPad(){ const out=ctx.createGain(); out.gain.value=.8; const notes=[220,277.18,329.63,440]; const oscs=notes.map((f,i)=>{ const o=ctx.createOscillator(); o.type='sine'; o.frequency.value=f; const g=ctx.createGain(); g.gain.value=0.15 - i*0.02; o.connect(g).connect(out); return o; }); const lfo=ctx.createOscillator(); lfo.type='sine'; lfo.frequency.value=.08; const lfoG=ctx.createGain(); lfoG.gain.value=.25; lfo.connect(lfoG); lfoG.connect(out.gain); return {start(){oscs.forEach(o=>o.start()); lfo.start();}, stop(){oscs.forEach(o=>{try{o.stop();}catch{}}); try{lfo.stop();}catch{}}, node:out}; }
    function makeChimes(){ const out=ctx.createGain(); out.gain.value=.8; let id; function note(f,d=.9){ const o=ctx.createOscillator(); o.type='triangle'; o.frequency.value=f; const g=ctx.createGain(); g.gain.value=.0001; const lp=ctx.createBiquadFilter(); lp.type='lowpass'; lp.frequency.value=3000; o.connect(lp).connect(g).connect(out); const now=ctx.currentTime; g.gain.setValueAtTime(.0001,now); g.gain.exponentialRampToValueAtTime(.35,now+.04); g.gain.exponentialRampToValueAtTime(.0001,now+d); o.start(); o.stop(now+d+.02);} return {start(){ const scale=[523.25,587.33,659.25,783.99,880.00]; let i=0; id=setInterval(()=>{ note(scale[i%scale.length]*(Math.random()<0.4?2:1)); i++; },1200); }, stop(){ if(id) clearInterval(id); }, node:out}; }
    function makeSoftBells(){ const out=ctx.createGain(); out.gain.value=.7; let id; function bell(){ const f=440*Math.pow(2, Math.floor(Math.random()*5)/12); const o=ctx.createOscillator(); o.type='sine'; const g=ctx.createGain(); g.gain.value=0.0001; o.connect(g).connect(out); const now=ctx.currentTime; g.gain.setValueAtTime(0.0001, now); g.gain.exponentialRampToValueAtTime(0.25, now+0.03); g.gain.exponentialRampToValueAtTime(0.0001, now+1.2); o.start(now); o.stop(now+1.3);} return {start(){ id=setInterval(bell, 1400); }, stop(){ if(id) clearInterval(id); }, node:out}; }

    function startBreakSound(kind){ ensureAudio(); const maker={ambient:makeAmbientPad,chimes:makeChimes,softbells:makeSoftBells,ocean:makeOceanNode,silence:()=>({start(){},stop(){},node:ctx.createGain()})}[kind]||makeAmbientPad; const unit=maker(); const g=ctx.createGain(); g.gain.value=0.0; unit.node.connect(g).connect(masterGain); unit.start(); if(duckingEl.value==='true') rampGain(g,1.0,1.0); else g.gain.value=1.0; return ()=>{ if(duckingEl.value==='true'){ rampGain(g,0.0,0.8); setTimeout(()=>{unit.stop(); g.disconnect();},850);} else { try{unit.stop();}catch{} g.disconnect(); } }; }

    // End-of-phase chimes
    function playChime(kind){ ensureAudio(); if(kind==='none') return; const out=ctx.createGain(); out.gain.value=0.0; out.connect(masterGain); const now=ctx.currentTime; const envDur = (kind==='gong')?3.8:2.8; const partials = (kind==='gong')? [180, 240, 320, 420, 520] : [440, 660, 880, 990]; const gains =     (kind==='gong')? [0.9, 0.6, 0.45, 0.3, 0.22] : [0.8, 0.35, 0.25, 0.15]; const oscs=[]; for(let i=0;i<partials.length;i++){ const o=ctx.createOscillator(); o.type = (kind==='gong')?'sine':'sine'; o.frequency.value=partials[i]; const g=ctx.createGain(); g.gain.value = 0.0001; o.connect(g).connect(out); g.gain.setValueAtTime(0.0001, now); g.gain.exponentialRampToValueAtTime(gains[i], now+0.02+i*0.005); g.gain.exponentialRampToValueAtTime(0.0001, now+envDur*(1 - i*0.06)); o.start(now); o.stop(now+envDur+0.2); oscs.push(o);} // ramp master chime
      out.gain.setValueAtTime(0.0001, now); out.gain.exponentialRampToValueAtTime(0.9, now+0.01); out.gain.exponentialRampToValueAtTime(0.0001, now+envDur+0.25);
      setTimeout(()=>{ try{out.disconnect();}catch{} }, (envDur+0.3)*1000);
    }

    // ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
    // Timer Logic
    // ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
    let ticker=null; let remaining=0; let totalPhase=0; let currentPhase='idle'; let stopCurrentSound=null; let totalCycles=1, cyclesDone=0, currentCycle=0;

    function updateRing(){ const CIRC=2*Math.PI*45; const done=(totalPhase>0? (1-remaining/totalPhase):0); ringEl.setAttribute('stroke-dasharray', CIRC.toFixed(1)); ringEl.setAttribute('stroke-dashoffset', (CIRC*(1-done)).toFixed(1)); }

    function updateUI(){ timeEl.textContent=fmt(Math.max(0,remaining)); caption.textContent= currentPhase==='focus' ? i18n[LANG].focusCap : currentPhase==='break' ? i18n[LANG].breakCap : i18n[LANG].ready; phaseTitle.textContent= currentPhase==='focus' ? i18n[LANG].focus : currentPhase==='break' ? i18n[LANG].break : i18n[LANG].ready; pauseBtn.disabled=(currentPhase==='idle'); resetBtn.disabled=(currentPhase==='idle'); setCycleInfo(); updateRing(); }

    function clearTicker(){ if(ticker){ clearInterval(ticker); ticker=null; } }

    const LONG_BREAK_EVERY = 4;
    function startPhase(name, seconds){ currentPhase=name; remaining=seconds; totalPhase=seconds; updateUI(); clearTicker(); ticker=setInterval(()=>{ remaining-=1; updateUI(); if(remaining<=0){ clearTicker(); onPhaseEnd(); } },1000); }

    function onPhaseEnd(){ if(stopCurrentSound){ stopCurrentSound(); stopCurrentSound=null; } playChime(endSignalEl.value); if(currentPhase==='focus'){ const useLong = (currentCycle % LONG_BREAK_EVERY === 0); const brkMin=parseFloat(useLong? longBreakMinutesEl.value : breakMinutesEl.value) || 5; const brkSec=Math.max(1, brkMin)*60; if(useLong){ speakMsg('long_break'); } else { speakMsg('start_break'); } stopCurrentSound=startBreakSound(breakSoundEl.value); startPhase('break', brkSec); } else if(currentPhase==='break'){ cyclesDone+=1; if(cyclesDone<totalCycles){ speakMsg('next_focus'); startCycle(); } else { const ask=()=>{ repeatDialog.showModal(); }; speakMsg('cycle_end'); setTimeout(ask, 250); currentPhase='idle'; updateUI(); startBtn.disabled=false; pauseBtn.disabled=true; } } }

    function startCycle(){ ensureAudio(); clearTicker(); if(stopCurrentSound){ stopCurrentSound(); stopCurrentSound=null; } currentCycle=cyclesDone+1; const focSec=Math.max(1, parseFloat(focusMinutesEl.value)||25)*60; stopCurrentSound=startNature(focusSoundEl.value); startPhase('focus', focSec); startBtn.disabled=true; pauseBtn.disabled=false; resetBtn.disabled=false; }

    function startRun(){ totalCycles=Math.max(1, parseInt(cyclesCountEl.value,10) || 1); cyclesDone=0; currentCycle=0; startCycle(); }

    function resume(){ if(ctx && ctx.state==='suspended'){ ctx.resume(); } }

    // ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
    // Events
    // ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
    startBtn.addEventListener('click', ()=> startRun());

    pauseBtn.addEventListener('click', ()=>{
      if(!ctx) return;
      if(ctx.state==='running'){
        ctx.suspend(); clearTicker(); pauseBtn.textContent=i18n[LANG].resume;
      } else {
        ctx.resume(); clearTicker(); ticker=setInterval(()=>{ remaining-=1; updateUI(); if(remaining<=0){ clearTicker(); onPhaseEnd(); } },1000); pauseBtn.textContent=i18n[LANG].pause;
      }
    });

    resetBtn.addEventListener('click', ()=>{
      clearTicker(); if(stopCurrentSound){ stopCurrentSound(); stopCurrentSound=null; }
      currentPhase='idle'; remaining=parseFloat(focusMinutesEl.value)*60 || 1500; totalPhase=remaining; totalCycles=Math.max(1, parseInt(cyclesCountEl.value,10) || 1); cyclesDone=0; currentCycle=0; updateUI(); startBtn.disabled=false; pauseBtn.disabled=true; pauseBtn.textContent=i18n[LANG].pause; resetBtn.disabled=true; if(ctx && ctx.state==='suspended') ctx.resume();
    });

    repeatYes && repeatYes.addEventListener('click', ()=>{ repeatDialog.close(); speakMsg('next_focus'); setTimeout(()=> startRun(), 300); });
    repeatNo && repeatNo.addEventListener('click', ()=> repeatDialog.close());

    // Test buttons
    const t1=$('#test1'), t2=$('#test2'), t3=$('#test3');
    if(t1){ t1.addEventListener('click', ()=>{ focusMinutesEl.value=0.1; focusRange.value=0.1; breakMinutesEl.value=0.05; breakRange.value=0.05; cyclesCountEl.value=2; longBreakMinutesEl.value=0.2; updateInitialTime(); startRun(); }); }
    if(t2){ t2.addEventListener('click', ()=>{ focusMinutesEl.value=0.2; focusRange.value=0.2; breakMinutesEl.value=0.1; breakRange.value=0.1; cyclesCountEl.value=3; longBreakMinutesEl.value=0.25; updateInitialTime(); startRun(); }); }
    if(t3){ t3.addEventListener('click', ()=>{ focusMinutesEl.value=0.05; focusRange.value=0.05; breakMinutesEl.value=0.03; breakRange.value=0.03; longBreakMinutesEl.value=0.08; cyclesCountEl.value=4; updateInitialTime(); startRun(); }); }

    function updateInitialTime(){ remaining=parseFloat(focusMinutesEl.value)*60; totalPhase=remaining; updateUI(); }

    // Language & Theme switchers
    langSel.addEventListener('change', ()=>{ LANG=langSel.value; applyLang(); });
    themeSel.addEventListener('change', ()=>{ const v=themeSel.value; document.body.classList.toggle('light', v==='light'); });

    // Initial UI
    applyLang();
    updateInitialTime();
  </script>
</body>
</html>
